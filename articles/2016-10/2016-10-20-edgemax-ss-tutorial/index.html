<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="SWFq03qXVniuU8xSmbU_-cfB6k7ySTaMohC_RBDdAvI" />










  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="GFW,防火墙,EdgeMax,路由器," />





  <link rel="alternate" href="/atom.xml" title="Allen's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/assets/images/blog-img/favicon.png?v=5.0.2" />






<meta name="description" content="作为肉身在墙内的计算机科学技术人员，不能上google实在是一件很遗憾的事情。

什么？你说用百度？你站出来，我是你老板我肯定会开除你。

 百度搜索简直是垃圾中的战斗机，在使用百度时，你不得不忍受他的各种广告，各种竞价排名，而且英文资料极少。很多领先的开源作品、解决方案、论文什么的基本都是国外的。这些资料你查不到，你说什么与国际先进技术接轨？总之，没用过 Google 之前，你可能没什么感觉，但">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 EdgeMax 路由器自动翻墙">
<meta property="og:url" content="http://allenn.cn/articles/2016-10/2016-10-20-edgemax-ss-tutorial/index.html">
<meta property="og:site_name" content="Allen's Blog">
<meta property="og:description" content="作为肉身在墙内的计算机科学技术人员，不能上google实在是一件很遗憾的事情。

什么？你说用百度？你站出来，我是你老板我肯定会开除你。

 百度搜索简直是垃圾中的战斗机，在使用百度时，你不得不忍受他的各种广告，各种竞价排名，而且英文资料极少。很多领先的开源作品、解决方案、论文什么的基本都是国外的。这些资料你查不到，你说什么与国际先进技术接轨？总之，没用过 Google 之前，你可能没什么感觉，但">
<meta property="og:image" content="http://allenn.cn/assets/images/2016-10-20-edgemas-ss-tutorial/proxy-flow.png">
<meta property="og:updated_time" content="2016-10-26T15:48:52.111Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用 EdgeMax 路由器自动翻墙">
<meta name="twitter:description" content="作为肉身在墙内的计算机科学技术人员，不能上google实在是一件很遗憾的事情。

什么？你说用百度？你站出来，我是你老板我肯定会开除你。

 百度搜索简直是垃圾中的战斗机，在使用百度时，你不得不忍受他的各种广告，各种竞价排名，而且英文资料极少。很多领先的开源作品、解决方案、论文什么的基本都是国外的。这些资料你查不到，你说什么与国际先进技术接轨？总之，没用过 Google 之前，你可能没什么感觉，但">
<meta name="twitter:image" content="http://allenn.cn/assets/images/2016-10-20-edgemas-ss-tutorial/proxy-flow.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '604590',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://allenn.cn/articles/2016-10/2016-10-20-edgemax-ss-tutorial/"/>


  <title> 使用 EdgeMax 路由器自动翻墙 | Allen's Blog </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-36907890-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?2ef044f665c8137864db5a2f0321c0f1";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Allen's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                使用 EdgeMax 路由器自动翻墙
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-20T22:21:39+08:00" content="2016-10-20">
              2016-10-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/网络技术/" itemprop="url" rel="index">
                    <span itemprop="name">网络技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/articles/2016-10/2016-10-20-edgemax-ss-tutorial/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="articles/2016-10/2016-10-20-edgemax-ss-tutorial/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>作为肉身在墙内的计算机科学技术人员，不能上google实在是一件很遗憾的事情。</p>
<blockquote>
<p>什么？你说用百度？你站出来，我是你老板我肯定会开除你。</p>
</blockquote>
<p> 百度搜索简直是垃圾中的战斗机，在使用百度时，你不得不忍受他的各种广告，各种竞价排名，而且英文资料极少。很多领先的开源作品、解决方案、论文什么的基本都是国外的。这些资料你查不到，你说什么与国际先进技术接轨？总之，没用过 Google 之前，你可能没什么感觉，但是用过了之后再用”某度”，你会抱怨，这搜的是些什么破玩意儿。。。但是，因为众所周知的原因，我们无法直接访问 Google，不能访问一些很优秀的国外网站，比如 slideshare（里面有很多优秀的PPT、文档）等等。那么怎么办？答案就是：翻墙！</p>
 <a id="more"></a>
<blockquote>
<p>网监同志，我知道你在盯着我，我写这个纯粹是为了方便技术人员查阅资料，作为爱党爱国的四有青年，我翻墙出去后保证不受反动思想的荼毒，努力在墙外为祖国占领舆论高地</p>
</blockquote>
<p> 翻墙的姿势有很多，什么 VPN，代理，自由门等等，本人也尝试过不少，目前来说用得最稳定的当属<a href="https://shadowsocks.org" target="_blank" rel="external">Shadowsocks</a>。刚开始的时候只是在一个 Shadowsocks 服务提供商处购买了一个账号，在我的 Macbook 上试用，后面发现翻墙速度快且稳定，就萌生了在路由器上安装 Shadowsocks 的想法，正好家中的主路由器是 EdgeRouter Lite 3（Unix 架构，完美！），于是：Let’s do it!</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在搜索引擎中输入<code>Shadowsocks+路由器</code>关键字，可以搜索出很多安装教程，采用的方案也不尽相同，建议不想太折腾的话就买一个可以刷 OpenWRT 的路由器，按照这个博客（<a href="https://cokebar.info/archives/978" target="_blank" rel="external">https://cokebar.info/archives/978</a>）的教程安装配置就可以了。如果你和我一样入了 EdgeRouter 的坑，那我们继续~。</p>
<p>我采用的方案是使用 Shadowsocks + ChinaDNS + DNSMasq + iptables 来实现路由器智能翻墙，即国内流量走正常网络，国外流量走 Shadowsocks 代理，总体流程如下图：</p>
<p><img src="/assets/images/2016-10-20-edgemas-ss-tutorial/proxy-flow.png" alt="流程图"></p>
<h2 id="所需软件"><a href="#所需软件" class="headerlink" title="所需软件"></a>所需软件</h2><h3 id="shadowsocks-libev"><a href="#shadowsocks-libev" class="headerlink" title="shadowsocks-libev"></a>shadowsocks-libev</h3><p>项目地址：<a href="https://github.com/shadowsocks/shadowsocks-libev" target="_blank" rel="external">https://github.com/shadowsocks/shadowsocks-libev</a>，可下载源码在路由器上进行编译，或者直接下载<a href="https://www.onlyos.com/wp-content/uploads/2015/08/shadowsocks-libev_2.2.4-1_mips.zip" target="_blank" rel="external">安装包</a>，请注意这个安装包只适用于 EdgeRouter Lite 3，其他 EdgeMax 产品需要自行编译。</p>
<h3 id="ChinaDNS"><a href="#ChinaDNS" class="headerlink" title="ChinaDNS"></a>ChinaDNS</h3><p>项目地址：<a href="https://github.com/shadowsocks/ChinaDNS" target="_blank" rel="external">https://github.com/shadowsocks/ChinaDNS</a>，可下载源码在路由器上进行编译，或者直接下载<a href="https://www.onlyos.com/wp-content/uploads/2015/08/chinadns-1.3.2.zip" target="_blank" rel="external">安装包</a>，请注意这个安装包只适用于 EdgeRouter Lite 3，其他 EdgeMax 产品需要自行编译。</p>
<h3 id="DNSMasq"><a href="#DNSMasq" class="headerlink" title="DNSMasq"></a>DNSMasq</h3><p>EdgeMax 中已经集成了 DNSMasq 无需另外安装。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="shadowsocks-libev-1"><a href="#shadowsocks-libev-1" class="headerlink" title="shadowsocks-libev"></a>shadowsocks-libev</h3><p>shadowsocks-libev 安装好后，会在<code>/etc/init.d/</code>中安装一个启动脚本：<code>shadowsock-libev</code>，在路由器启动时会默认启动<code>ss-redir</code>服务，如果需要重启 Shadowsocks，可以使用命令：<code>sudo /etc/init.d/shadowsock-libev [start|stop|restart]</code>。Shadowsocks 的配置在文件<code>/etc/shadowsocks-libev/config.json</code>中，在这个文件中配置 Shadowsocks 需要链接的服务器信息：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">&quot;server”:”127.0.0.1″,</div><div class="line">&quot;server_port&quot;:8388,</div><div class="line">&quot;local”: &quot;0.0.0.0”,</div><div class="line">&quot;local_port”:1080,</div><div class="line">&quot;password”:”barfoo!”,</div><div class="line">&quot;timeout”:60,</div><div class="line">&quot;method”:null</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>配置完成后，<code>sudo /etc/init.d/shadowsock-libev restart</code>，这样 Shadowsocks 就在你的路由器上运行了。</p>
<h3 id="ChinaDNS-1"><a href="#ChinaDNS-1" class="headerlink" title="ChinaDNS"></a>ChinaDNS</h3><p>使用源码编译后，会生成一个二进制文件：chinadns，可以将这个文件复制到<code>/usr/bin</code>中方便后面使用。ChinaDNS 需要一个文件来标识哪些 IP 属于国内，这个文件可以从<a href="http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest" target="_blank" rel="external">这里下载</a>：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># 下载 ip 列表到： /tmp/chnroute.txt</div><div class="line">curl &apos;http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest&apos; | grep ipv4 | grep CN | awk -F| ‘&#123; printf(“%s/%dn”, $4, 32-log($5)/log(2)) &#125;’ &gt; /tmp/chnroute.txt</div></pre></td></tr></table></figure>
<p>下载完成后，将文件移动到<code>/etc/chinadns/chnroute.txt</code>，接着我们就可以尝试启动 ChinaDNS 了：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">chinadns -s 223.5.5.5,223.6.6.6,127.0.0.1:5300 -c /etc/chinadns/chnroute.txt -p 35353 -m</div></pre></td></tr></table></figure>
<p>需要注意的是<code>-s</code>参数后面的<code>127.0.0.1:5300</code>，这个代表将<code>ss-tunnel</code>转发的国外可信DNS站点作为上游DNS服务器。</p>
<h4 id="ChinaDNS参数详解"><a href="#ChinaDNS参数详解" class="headerlink" title="ChinaDNS参数详解"></a>ChinaDNS参数详解</h4><ul>
<li>-l：虚假IP列表：默认值：/etc/chinadns_iplist.txt</li>
</ul>
<p>是GFW常见的DNS污染用IP列表，解析出列表中的IP结果时候，ChinaDNS会自动抛弃，保留默认即可；</p>
<ul>
<li>-c：chnroute文件：默认值：/etc/chinadns_chnroute.txt</li>
</ul>
<p>此文件标识哪些IP属于国内。用于ChinaDNS判断解析结果。ChinaDNS要求解析结果与DNS要匹配，国内网站采用国内DNS解析的结果，国外网站采用国外DNS解析结果，等等规则；确保以上两个文件内容完整无误，否则会造成无法启动；</p>
<ul>
<li>-p：本地端口：默认值：5353</li>
</ul>
<p>ChinaDNS所监听的端口。根据实际情况更改，注意不能和其他服务的端口重复（特别是DNSMasq和shadowsocks）；</p>
<ul>
<li>-s: 上游服务器：默认值：114.114.114.114,8.8.8.8</li>
</ul>
<p>可填入一系列的上游DNS服务器，根据实际情况来，可以保留默认，格式为”DNS_IP:PORT,DNS_IP:PORT”注意逗号后面不能有空格。有些ISP会封杀公共DNS，此时请将114DNS改为ISP的DNS；此处必须至少填入一个国内IP的DNS和一个国外IP的DNS，否则会造成ChinaDNS启动失败。额外的用法：ChinaDNS添加可信DNS避免一些异常</p>
<ul>
<li>-y：等待时间： 默认值：0.3</li>
</ul>
<p>为防止GFW的DNS污染抢答，而设置一个等待时间，请根据自己填写的国外DNS延迟值来填写，留下一定的裕度。GoogleDNS在国内延迟一般在100-200ms，留0.3比较合适。过大的值会造成DNS解析较大的延迟时间，过小的值可能导致无法接收正确的解析结果。</p>
<ul>
<li>-d：双向过滤： 默认：开启</li>
</ul>
<p>勾选时，当国外DNS服务器返回的查询结果是国内IP，或者当国内DNS服务器返回的查询结果是国外IP，则过滤掉这个结果（较为严格的模式）；去掉勾选的话只是过滤国内DNS的国外IP结果。</p>
<ul>
<li>-m：启用压缩指针： 默认：不开启</li>
</ul>
<p>利用GFW遇到压缩指针时的一个bug来精确识别来自GFW的抢答污染，从而极大提高识别的准确性和识别的效率，推荐启用，启用后，IPList和等待时间将禁用（因为用不到了）。 （已强制开启）</p>
<h3 id="ss-tunnel"><a href="#ss-tunnel" class="headerlink" title="ss-tunnel"></a>ss-tunnel</h3><p>ss-tunnel 是 Shadowsocks 的一个模块，可以用于 UDP 转发，为了防止 GFW 的 DNS 污染，我们用它来转发国外 DNS，可以通过下面命令来启动 ss-tunnel：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">ss-tunnel -c /etc/shadowsocks-libev/config.json -u -b 0.0.0.0 -l 5300 -L 8.8.8.8:53</div></pre></td></tr></table></figure>
<p>为了让 ss-tunnel 在每次重启路由器的时候自动重启，我们可以写个脚本放在<code>/config/scripts/post-config.d</code>目录下。</p>
<h3 id="DNSMasq-1"><a href="#DNSMasq-1" class="headerlink" title="DNSMasq"></a>DNSMasq</h3><p>首先需要将系统的 DNS 服务器设置为本地</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">configure</div><div class="line"># 停止通过pppoe更新dns设置，如果pppoe绑定在其他网口上，eth0需要变更为对应网口</div><div class="line">set interfaces ethernet eth0 pppoe 0 name-server none</div><div class="line"></div><div class="line"># 设置 DNSMasq 使用 ChinaDNS</div><div class="line"># 需要注意的是，这里无法设置服务器端口，只能先这样设置后，再手工变更配置文件</div><div class="line">edit service dns forwarding</div><div class="line">set name-server 127.0.0.1</div><div class="line"></div><div class="line"># 告诉路由器使用本地 DNSMasq 来解析域名</div><div class="line">set system name-server 127.0.0.1</div><div class="line"></div><div class="line">commit</div><div class="line">save</div><div class="line">exit</div></pre></td></tr></table></figure>
<p>修改<code>/etc/dnsmasq.conf</code>，去除你之前自定义的规则，在最后加入<code>conf-dir=/etc/dnsmasq.d</code>，并将<code>server=127.0.0.1</code>修改为<code>server=127.0.0.1#35353</code>。新建并进入目录<code>/etc/dnsmasq.d</code>，下载 <a href="https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/master/accelerated-domains.china.conf" target="_blank" rel="external">accelerated-domains.china.conf</a> 和<a href="http://pan.baidu.com/s/1eQB7ACi" target="_blank" rel="external">foreign_list.conf</a>两个文件后复制两个文件到<code>/etc/dnsmasq.d</code>目录。这两个文件都会有更新，建议隔段时间更新一下。分别修改两个文件，将<code>accelerated-domains.china.conf</code>（ChinaList）文件中所有的的114.114.114.114修改为自己ISP的DNS或者其他效果更好的国内DNS的IP地址（也可以保留114DNS），格式为：<code>server=/0-6.com/IP</code>；将<code>foreign_list.conf</code>（GFWList）文件中所有的 127.0.0.1#5300 修改为自己所用国外DNS，格式为：<code>server=/.lsxszzg.com/IP#PORT</code>，如果你使用shadowsocks的UDP转发来提供国外DNS解析，UDP转发的端口号为5300，那么就是默认的 127.0.0.1#5300 ，如果你使用一个非标端口的国外DNS服务，如3.4.5.6，端口5353，那么就改为 3.4.5.6#5353 。注意不要使用国外公共DNS，因为会被污染！最后重启 dnsmasq：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sudo /etc/init.d/dnsmasq restart</div></pre></td></tr></table></figure>
<h3 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h3><p>上面所做的一切都是为了防止 GFW 的 DNS 污染，从而拿到正确的 IP 地址，那么拿到 IP 地址后，又如何将国外的流量转发到 Shadowsocks 呢？现在该 iptables 登场了，使用下面的代码设置 iptables 转发规则：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># Setup the ipset</div><div class="line">ipset -N chnroute hash:net maxelem 65536</div><div class="line"></div><div class="line">for ip in $(cat &apos;/etc/chinadns/chnroute.txt&apos;); do</div><div class="line">  ipset add chnroute $ip</div><div class="line">done</div><div class="line"></div><div class="line"># 其他请求：</div><div class="line"># shadowsocks</div><div class="line">iptables -t nat -N SHADOWSOCKS</div><div class="line"></div><div class="line">iptables -t nat -A SHADOWSOCKS -p tcp --dport 33348 -j RETURN</div><div class="line">iptables -t nat -A SHADOWSOCKS -d 103.192.224.122 -j RETURN</div><div class="line"></div><div class="line"># ignore internal ip</div><div class="line">iptables -t nat -A SHADOWSOCKS -d 0.0.0.0/8 -j RETURN</div><div class="line">iptables -t nat -A SHADOWSOCKS -d 10.0.0.0/8 -j RETURN</div><div class="line">iptables -t nat -A SHADOWSOCKS -d 127.0.0.0/8 -j RETURN</div><div class="line">iptables -t nat -A SHADOWSOCKS -d 169.254.0.0/16 -j RETURN</div><div class="line">iptables -t nat -A SHADOWSOCKS -d 172.16.0.0/12 -j RETURN</div><div class="line">iptables -t nat -A SHADOWSOCKS -d 192.168.0.0/16 -j RETURN</div><div class="line">iptables -t nat -A SHADOWSOCKS -d 224.0.0.0/4 -j RETURN</div><div class="line">iptables -t nat -A SHADOWSOCKS -d 240.0.0.0/4 -j RETURN</div><div class="line"></div><div class="line"># ignore asia ip</div><div class="line"></div><div class="line"># Allow connection to chinese IPs</div><div class="line">iptables -t nat -A SHADOWSOCKS -p tcp -m set --match-set chnroute dst -j RETURN</div><div class="line"></div><div class="line">iptables -t nat -A SHADOWSOCKS -p tcp -j REDIRECT --to-ports 1080</div><div class="line">iptables -t nat -I PREROUTING -p tcp -j SHADOWSOCKS</div></pre></td></tr></table></figure>
<p>iptables 配置完后，你应该可以再浏览器中正常的打开 Google 首页了。</p>
<h3 id="一键式-DNS-配置脚本"><a href="#一键式-DNS-配置脚本" class="headerlink" title="一键式 DNS 配置脚本"></a>一键式 DNS 配置脚本</h3><p>使用下面的脚本可以在重启路由器时（需要将脚本放在<code>/config/scripts/post-config.d</code>目录下）更新<code>foreign_list.conf</code>和<code>accelerated-domains.china.conf</code>两个文件，并配置好 iptables：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#!/bin/sh</div><div class="line"></div><div class="line">deleteFile() &#123;</div><div class="line">  local filePath=$1</div><div class="line">  if [ -f &quot;$filePath&quot; ]; then</div><div class="line">   rm &quot;$filePath&quot;</div><div class="line">  fi</div><div class="line">&#125;</div><div class="line"># get chinadns ignore list</div><div class="line">updateChnroute() &#123;</div><div class="line">  deleteFile /tmp/chnroute.txt</div><div class="line"></div><div class="line">  curl &apos;http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest&apos; | grep ipv4 | grep CN | awk -F\| &apos;&#123; printf(&quot;%s/%d\n&quot;, $4, 32-log($5)/log(2)) &#125;&apos; &gt;  /tmp/chnroute.txt</div><div class="line">  mv -f /tmp/chnroute.txt /etc/chinadns/</div><div class="line">  chmod 644 /etc/chinadns/chnroute.txt</div><div class="line"></div><div class="line">  if pidof chinadns&gt;/dev/null; then</div><div class="line">      /etc/init.d/chinadns restart</div><div class="line">  fi</div><div class="line">&#125;</div><div class="line"></div><div class="line">updateDnsmasqConf() &#123;</div><div class="line">  deleteFile /tmp/accelerated-domains.china.conf</div><div class="line">  # download accelerated-domains.china.conf</div><div class="line">  local DNS=223.5.5.5</div><div class="line">  curl &apos;https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/master/accelerated-domains.china.conf&apos; &gt; /tmp/accelerated-domains.china.conf</div><div class="line">  sed -i &quot;s|^\(server.*\)/[^/]*$|\1/$DNS|&quot;  /tmp/accelerated-domains.china.conf</div><div class="line">  mv -f /tmp/accelerated-domains.china.conf /etc/dnsmasq.d/</div><div class="line">  chmod 644 /etc/dnsmasq.d/accelerated-domains.china.conf</div><div class="line"></div><div class="line">  # download foreign_list.conf</div><div class="line">  python ../gfwlist2dnsmasq_noipset.py</div><div class="line"></div><div class="line">  if pidof dnsmasq&gt;/dev/null; then</div><div class="line">      /etc/init.d/dnsmasq restart</div><div class="line">  fi</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">configIptables() &#123;</div><div class="line">  # Setup the ipset</div><div class="line">  ipset -N chnroute hash:net maxelem 65536</div><div class="line"></div><div class="line">  for ip in $(cat &apos;/etc/chinadns/chnroute.txt&apos;); do</div><div class="line">    ipset add chnroute $ip</div><div class="line">  done</div><div class="line"></div><div class="line">  # 其他请求：</div><div class="line">  # shadowsocks</div><div class="line">  iptables -t nat -N SHADOWSOCKS</div><div class="line"></div><div class="line">  iptables -t nat -A SHADOWSOCKS -p tcp --dport 33348 -j RETURN</div><div class="line">  iptables -t nat -A SHADOWSOCKS -d 103.192.224.122 -j RETURN</div><div class="line"></div><div class="line">  # ignore internal ip</div><div class="line">  iptables -t nat -A SHADOWSOCKS -d 0.0.0.0/8 -j RETURN</div><div class="line">  iptables -t nat -A SHADOWSOCKS -d 10.0.0.0/8 -j RETURN</div><div class="line">  iptables -t nat -A SHADOWSOCKS -d 127.0.0.0/8 -j RETURN</div><div class="line">  iptables -t nat -A SHADOWSOCKS -d 169.254.0.0/16 -j RETURN</div><div class="line">  iptables -t nat -A SHADOWSOCKS -d 172.16.0.0/12 -j RETURN</div><div class="line">  iptables -t nat -A SHADOWSOCKS -d 192.168.0.0/16 -j RETURN</div><div class="line">  iptables -t nat -A SHADOWSOCKS -d 224.0.0.0/4 -j RETURN</div><div class="line">  iptables -t nat -A SHADOWSOCKS -d 240.0.0.0/4 -j RETURN</div><div class="line"></div><div class="line">  # ignore asia ip</div><div class="line"></div><div class="line">  # Allow connection to chinese IPs</div><div class="line">  iptables -t nat -A SHADOWSOCKS -p tcp -m set --match-set chnroute dst -j RETURN</div><div class="line"></div><div class="line">  iptables -t nat -A SHADOWSOCKS -p tcp -j REDIRECT --to-ports 1080</div><div class="line">  iptables -t nat -I PREROUTING -p tcp -j SHADOWSOCKS</div><div class="line">&#125;</div><div class="line"></div><div class="line">updateChnroute</div><div class="line">updateDnsmasqConf</div><div class="line">configIptables</div></pre></td></tr></table></figure>
<p>gfwlist2dnsmasq_noipset.py：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line">#coding=utf-8</div><div class="line">#</div><div class="line"># Generate a list of dnsmasq rules with ipset for gfwlist</div><div class="line">#</div><div class="line"># Copyright (C) 2014 http://www.shuyz.com</div><div class="line"># Ref https://code.google.com/p/autoproxy-gfwlist/wiki/Rules</div><div class="line"></div><div class="line">import urllib2</div><div class="line">import re</div><div class="line">import os</div><div class="line">import datetime</div><div class="line">import base64</div><div class="line">import shutil</div><div class="line">import ssl</div><div class="line"></div><div class="line">mydnsip = &apos;127.0.0.1&apos;</div><div class="line">mydnsport = &apos;5300&apos;</div><div class="line"># Extra Domain;</div><div class="line">EX_DOMAIN=[ \</div><div class="line">&apos;.google.com&apos;, \</div><div class="line">&apos;.google.com.hk&apos;, \</div><div class="line">&apos;.google.com.tw&apos;, \</div><div class="line">&apos;.google.com.sg&apos;, \</div><div class="line">&apos;.google.co.jp&apos;, \</div><div class="line">&apos;.google.co.kr&apos;, \</div><div class="line">&apos;.blogspot.com&apos;, \</div><div class="line">&apos;.blogspot.sg&apos;, \</div><div class="line">&apos;.blogspot.hk&apos;, \</div><div class="line">&apos;.blogspot.jp&apos;, \</div><div class="line">&apos;.blogspot.kr&apos;, \</div><div class="line">&apos;.gvt1.com&apos;, \</div><div class="line">&apos;.gvt2.com&apos;, \</div><div class="line">&apos;.gvt3.com&apos;, \</div><div class="line">&apos;.1e100.net&apos;, \</div><div class="line">&apos;.blogspot.tw&apos; \</div><div class="line">]</div><div class="line"></div><div class="line"># the url of gfwlist</div><div class="line">baseurl = &apos;https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt&apos;</div><div class="line"># match comments/title/whitelist/ip address</div><div class="line">comment_pattern = &apos;^\!|\[|^@@|^\d+\.\d+\.\d+\.\d+&apos;</div><div class="line">domain_pattern = &apos;([\w\-\_]+\.[\w\.\-\_]+)[\/\*]*&apos;</div><div class="line">ip_pattern = re.compile(r&apos;\b\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\b&apos;)</div><div class="line">tmpfile = &apos;/tmp/gfwlisttmp&apos;</div><div class="line"># do not write to router internal flash directly</div><div class="line">outfile = &apos;/tmp/dnsmasq_list.conf&apos;</div><div class="line">rulesfile = &apos;/etc/dnsmasq.d/foreign_list.conf&apos;</div><div class="line"></div><div class="line">fs =  file(outfile, &apos;w&apos;)</div><div class="line">fs.write(&apos;# gfw list ipset rules for dnsmasq\n&apos;)</div><div class="line">fs.write(&apos;# updated on &apos; + datetime.datetime.now().strftime(&quot;%Y-%m-%d %H:%M:%S&quot;) + &apos;\n&apos;)</div><div class="line">fs.write(&apos;#\n&apos;)</div><div class="line"></div><div class="line">print &apos;fetching list...&apos;</div><div class="line">if hasattr(ssl, &apos;_create_unverified_context&apos;):</div><div class="line">truessl._create_default_https_context = ssl._create_unverified_context</div><div class="line">content = urllib2.urlopen(baseurl, timeout=15).read().decode(&apos;base64&apos;)</div><div class="line"></div><div class="line"># write the decoded content to file then read line by line</div><div class="line">tfs = open(tmpfile, &apos;w&apos;)</div><div class="line">tfs.write(content)</div><div class="line">tfs.close()</div><div class="line">tfs = open(tmpfile, &apos;r&apos;)</div><div class="line"></div><div class="line">print &apos;page content fetched, analysis...&apos;</div><div class="line"></div><div class="line"># remember all blocked domains, in case of duplicate records</div><div class="line">domainlist = []</div><div class="line"></div><div class="line"></div><div class="line">for line in tfs.readlines():</div><div class="line">trueif re.findall(comment_pattern, line):</div><div class="line">truetrueprint &apos;this is a comment line: &apos; + line</div><div class="line">truetrue#fs.write(&apos;#&apos; + line)</div><div class="line">trueelse:</div><div class="line">truetruedomain = re.findall(domain_pattern, line)</div><div class="line">truetrueif domain:</div><div class="line">truetruetruetry:</div><div class="line">truetruetruetruefound = domainlist.index(domain[0])</div><div class="line">truetruetruetrueprint domain[0] + &apos; exists.&apos;</div><div class="line">truetruetrueexcept ValueError:</div><div class="line">truetruetruetrueif ip_pattern.match(domain[0]):</div><div class="line">truetruetruetruetrueprint &apos;skipping ip: &apos; + domain[0]</div><div class="line">truetruetruetruetruecontinue</div><div class="line">truetruetruetrueprint &apos;saving &apos; + domain[0]</div><div class="line">truetruetruetruedomainlist.append(domain[0])</div><div class="line">truetruetruetruefs.write(&apos;server=/.%s/%s#%s\n&apos;%(domain[0],mydnsip,mydnsport))</div><div class="line">truetrueelse:</div><div class="line">truetruetrueprint &apos;no valid domain in this line: &apos; + line</div><div class="line"></div><div class="line">tfs.close()</div><div class="line"></div><div class="line">for each in EX_DOMAIN:</div><div class="line">truefs.write(&apos;server=/%s/%s#%s\n&apos;%(each,mydnsip,mydnsport))</div><div class="line"></div><div class="line">print &apos;write extra domain done&apos;</div><div class="line"></div><div class="line">fs.close();</div><div class="line">print &apos;moving generated file to dnsmasg directory&apos;</div><div class="line">shutil.move(outfile, rulesfile)</div><div class="line"></div><div class="line">print &apos;done!&apos;</div></pre></td></tr></table></figure>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/GFW/" rel="tag">#GFW</a>
          
            <a href="/tags/防火墙/" rel="tag">#防火墙</a>
          
            <a href="/tags/EdgeMax/" rel="tag">#EdgeMax</a>
          
            <a href="/tags/路由器/" rel="tag">#路由器</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/articles/2016-10/2016-10-20-learn-gfw/" rel="next" title="全面学习GFW">
                <i class="fa fa-chevron-left"></i> 全面学习GFW
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <div class="ds-share flat" data-thread-key="articles/2016-10/2016-10-20-edgemax-ss-tutorial/"
     data-title="使用 EdgeMax 路由器自动翻墙"
     data-content=""
     data-url="http://allenn.cn/articles/2016-10/2016-10-20-edgemax-ss-tutorial/">
  <div class="ds-share-inline">
    <ul  class="ds-share-icons-16">

      <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
      <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
      <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
      <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
      <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>

    </ul>
    <div class="ds-share-icons-more">
    </div>
  </div>
</div>
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="articles/2016-10/2016-10-20-edgemax-ss-tutorial/"
           data-title="使用 EdgeMax 路由器自动翻墙" data-url="http://allenn.cn/articles/2016-10/2016-10-20-edgemax-ss-tutorial/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/assets/images/blog-img/avatar.jpg"
               alt="Allen Zheng" />
          <p class="site-author-name" itemprop="name">Allen Zheng</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">18</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/allenn" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/xudongzheng1225" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/allenzheng1225" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://ifeve.com/" title="并发编程网" target="_blank">并发编程网</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#所需软件"><span class="nav-number">2.</span> <span class="nav-text">所需软件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#shadowsocks-libev"><span class="nav-number">2.1.</span> <span class="nav-text">shadowsocks-libev</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ChinaDNS"><span class="nav-number">2.2.</span> <span class="nav-text">ChinaDNS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DNSMasq"><span class="nav-number">2.3.</span> <span class="nav-text">DNSMasq</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置"><span class="nav-number">3.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#shadowsocks-libev-1"><span class="nav-number">3.1.</span> <span class="nav-text">shadowsocks-libev</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ChinaDNS-1"><span class="nav-number">3.2.</span> <span class="nav-text">ChinaDNS</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ChinaDNS参数详解"><span class="nav-number">3.2.1.</span> <span class="nav-text">ChinaDNS参数详解</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ss-tunnel"><span class="nav-number">3.3.</span> <span class="nav-text">ss-tunnel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DNSMasq-1"><span class="nav-number">3.4.</span> <span class="nav-text">DNSMasq</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#iptables"><span class="nav-number">3.5.</span> <span class="nav-text">iptables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一键式-DNS-配置脚本"><span class="nav-number">3.6.</span> <span class="nav-text">一键式 DNS 配置脚本</span></a></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Allen Zheng</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"alleeen"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
